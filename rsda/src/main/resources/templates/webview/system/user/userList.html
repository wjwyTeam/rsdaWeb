<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>layuiAdmin 用户</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="/layuiadmin/style/admin.css" media="all">
  <link rel="stylesheet" href="/css/zTreeStyle.css" media="all">
  <link rel="stylesheet" href="/css/metroStyle.css" type="text/css">
  <style>
    /* 防止下拉框的下拉列表被隐藏---必须设置--- */
    .layui-table-cell {
      overflow: visible !important;
    }

    /* 设置下拉框的高度与表格单元相同 */
    .layui-input,
    .layui-select,
    .layui-textarea {
      height: 30px !important;
    }
  </style>
</head>

<body>
  <div class="layui-row">
    <div class="layui-col-md2">
      <div class="zTreeDemoBackground left">
        <ul id="userTree" class="ztree"></ul>
      </div>
    </div>
    <div class="layui-col-md10">
      <div class="layui-card">
        <div class="layui-form layui-card-header layuiadmin-card-header-auto">
          <div class="layui-form-item">
            <div class="layui-inline">
              <label class="layui-form-label">ID</label>
              <div class="layui-input-block">
                <input type="text" name="id" placeholder="请输入" autocomplete="off" class="layui-input">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">用户名</label>
              <div class="layui-input-block">
                <input type="text" name="username" placeholder="请输入" autocomplete="off" class="layui-input">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">邮箱</label>
              <div class="layui-input-block">
                <input type="text" name="email" placeholder="请输入" autocomplete="off" class="layui-input">
              </div>
            </div>

            <div class="layui-inline">
              <button class="layui-btn layui-btn-sm" lay-submit lay-filter="user-search">
                <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="layui-card-body">
          <div style="padding-bottom:15px;">
            <button class="layui-btn layui-btn-sm" data-type="batchdel">删除</button>
            <button class="layui-btn layui-btn-sm" data-type="add">添加</button>
          </div>

          <table id="user-table" lay-filter="user-table"> </table>
          <input type="hidden" class="deptId">
          <script type="text/html" id="imgTpl" class="layui-hide">
          <img style="display: inline-block; width: 50%; height: 100%;" src= {{ d.avatar }}>
        </script>
          <script type="text/html" id="table-toolbar" th:inline="none">
          <a class="layui-btn layui-btn-normal layui-btn-sm" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
          <a class="layui-btn layui-btn-danger layui-btn-sm" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
          <a class="layui-btn layui-btn-danger layui-btn-sm" lay-event="userAndrole"><i class="layui-icon layui-icon-set"></i>授权</a>
        </script>
        </div>
      </div>
    </div>
  </div>
  <script src="/js/jquery-1.4.4.min.js" type="text/javascript" th:inline="none"></script>
  <script src="/js/jquery.ztree.core.js" type="text/javascript" th:inline="none"></script>
  <script src="/layuiadmin/layui/layui.js" type="text/javascript" th:inline="none"></script>
  <script type="text/javascript" th:inline="none">
    //Ztree
    function filter(treeId, parentNode, childNodes) {
      if (!childNodes) return null;
      for (var i = 0, l = childNodes.length; i < l; i++) {
        childNodes[i].name = childNodes[i].name;
      }
      return childNodes;
    }

    function zTreeOnClick(event, treeId, treeNode) {
      if (treeNode.id != '' || treeNode.id != 'undefined') {

        window.tableObj.reload('bindpersons', {
          where: {
            deptId: treeNode.id
          },
        }, 'data');
        $(".deptId").val(treeNode.id);
      }
    }
    var newCount = 1;
    function addHoverDom(treeId, treeNode) {
      var sObj = $("#" + treeNode.tId + "_span");
      if (treeNode.editNameFlag || $("#addBtn_" + treeNode.tId).length > 0) return;
      var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
        + "' title='add node' onfocus='this.blur();'></span>";
      sObj.after(addStr);
      var btn = $("#addBtn_" + treeNode.tId);
      if (btn) btn.bind("click", function () {
        var zTree = $.fn.zTree.getZTreeObj("treeDemo");
        zTree.addNodes(treeNode, { id: (100 + newCount), pId: treeNode.id, name: "new node" + (newCount++) });
        return false;
      });
    };
    function removeHoverDom(treeId, treeNode) {
      $("#addBtn_" + treeNode.tId).unbind().remove();
    };



    $(document).ready(function () {

      var setting = {
        async: {
          enable: true,
          url: "/dept/unitTree",
          autoParam: ["id=id"],
          contentType: "application/json"
        },
        data: {
          key: {
            name: "name",//节点显示的值
            isParent: "isParent"
          }
        },
        simpleData: {
          enable: true,//如果为true，可以直接把从数据库中得到的List集合自动转换为Array格式。而不必转换为json传递
          idKey: "id",//节点的id
          pIdKey: "parentId"//节点的父节点id
        },
        edit: {
          enable: true
        },
        view: {
          addHoverDom: addHoverDom,
          removeHoverDom: removeHoverDom,
          selectedMulti: false
        },
        callback: {
          onClick: zTreeOnClick
        }

      };
      window.zTreeObj = $.fn.zTree.init($("#userTree"), setting);
    });



    layui.config({
      base: '/layuiadmin/' //静态资源所在路径
    }).extend({
      index: 'lib/index' //主入口模块
    }).use(['index', 'table', 'tree', 'util'], function () {
      var $ = layui.$
        , form = layui.form
        , table = layui.table
        , tree = layui.tree
        , util = layui.util;
      window.tableObj = layui.table;



      //第一个实例
      table.render({
        elem: '#user-table'
        , even: true
        , height: "full-180"
        , title: '用户数据表'
        , width:'1000px'
        , method: 'post'
        , id: 'bindpersons'
        , toolbar: '#toolbarDemo' //开启头部工具栏，并为其绑定左侧模板
        , defaultToolbar: ['filter', 'exports', 'print']
        , totalRow: true
        , url: '/user/userPageInfoList' //数据接口
        , cols: [[ //表头
          { checkbox: true, align: 'center', LAY_CHECKED: false, filter: 'test' }
          , { type: 'numbers', title: '序号' }
          , { field: 'userName', title: '用户名', sort: true, width: 150 }
          , { field: 'userRealName', title: '姓名', sort: true, width: 150 }
          , { field: 'roles.name', title: '角色', sort: true, width: 165 }
          , { field: 'duty', title: '职务', sort: true, width: 150 }
          , { field: 'userType', title: '账号类型', sort: true, width: 150}
          , {
            field: 'createTime', title: '创建时间', width: 250, sort: true, templet: function (time) {
              return "<div>" + layui.util.toDateString(Date(time.createTime, 'yyyy-MM-dd HH:mm:ss')) + "</div>";
            }
          }
          , { fixed: 'right', title: '操作', width: 250, align: 'center', toolbar: '#table-toolbar' }
        ]]
        , page: false
        , response: {
          statusName: 'code' //数据状态的字段名称，默认：code'<div>{{ layui.util.toDateString(d.starttime, "yyyy-MM-dd HH:mm:ss") }}</div>'
          , statusCode: 200 //成功的状态码，默认：0
          , msgName: 'msg' //状态信息的字段名称，默认：msg
          , countName: 'count' //数据总数的字段名称，默认：count
          , dataName: 'data' //数据列表的字段名称，默认：data
        }
        , page: { //支持传入 laypage 组件的所有参数（某些参数除外，如：jump/elem） - 详见文档
          layout: ['limit', 'count', 'prev', 'page', 'next', 'skip'] //自定义分页布局
          //,curr: 5 //设定初始在第 5 页
          , groups: 5 //只显示 1 个连续页码
          , first: false //不显示首页
          , last: false //不显示尾页
        }
      });



      //监听工具条删除
      table.on('tool(user-table)', function (obj) {
        var data = obj.data;
        console.log(data)
        var urlData = { userId: data.userId };
        if (obj.event === 'detail') {
          layer.msg('ID：' + data.id + ' 的查看操作');
        } else if (obj.event === 'del') {
          layer.confirm('真的删除行么', function (index) {

            layer.close(index);
            $.post("/user/deleteUser", urlData, function (resultJSONObject) {
              console.log(resultJSONObject)
              if (resultJSONObject.success) {
                obj.del();
                layer.msg("删除成功");
              } else {
                layer.msg("禁止删除");
              }
            }, "json");
          });
        } else if (obj.event === 'edit') {
          //open 方法合作共用json串
          $.ajax({
            url: "/user/findoneUser",
            data: JSON.stringify(data),
            type: "post",
            dataType: "json",
            timeout: 3000,
            contentType: "application/json; charset=UTF-8",
            success: function (msgLog) {
                  layer.open({
                    type: 2,
                    title: '编辑用户',
                    maxmin: true
                    , area: ['700px', '550px']
                    , btn: ['确定', '取消']
                    , fixed: true
                    , shadeClose: true//开启遮罩关
                    , shade: 0.9 
                    , moveType: 1 //拖拽模式，0或者1 
                   , content: '/user/updateInfo?type=2',
                    yes: function (index, layero) {
                      console.log(data)
                      var iframeWindow = window['layui-layer-iframe' + index]
                        , submitID = 'LAY-user-front-submit'
                        , submit = layero.find('iframe').contents().find('#' + submitID);

                      //监听提交
                      iframeWindow.layui.form.on('submit(' + submitID + ')', function (dataLog) {
                        var field = dataLog.field;
                        console.log("监听提交 ===================" + data)
                        //获取提交的字段
                        //提交 Ajax 成功后，静态更新表格中的数据
                        $.ajax({
                          type: "post",
                          url: "/user/updateUser",
                          data: JSON.stringify(field),
                          dataType: "json",
                          contentType: "application/json;charset-UTF-8",
                          success: function (resultJSONObject) {
                            if (resultJSONObject.success) {
                              layer.msg("更新成功");
                            } else {
                              layer.msg("更新失败");
                            }
                            console.log(data)
                          }
                        });
                        table.reload('user-table'); //数据刷新
                        layer.close(index); //关闭弹层
                      });

                      submit.trigger('click');
                    }
                  });
                 }
              });
        
        } else if (obj.event === 'userAndrole') {
          $.ajax({
            url: "/role/findRolePage",
            data: JSON.stringify(data),
            type: "post",
            dataType: "json",
            timeout: 5000,
            contentType: "application/json; charset=UTF-8",
            success: function (msgLog) {
              layer.msg(msgLog.msg, {
                offset: '15px',
                icon: 6,
                time: 1000
              }, function () {
                if (msgLog.status) {
                  layer.open({
                    type: 2,
                    title: '角色',
                    maxmin: true
                    , area: ['500px', '450px']
                    , btn: ['确定', '取消']
                    , shadeClose: true//开启遮罩关
                    , shade: 0.9 
                    , moveType: 1 //拖拽模式，0或者1 
                    , content: '/role/assignRoles',
                    yes: function (index, layero) {
                      console.log(data)
                      var iframeWindow = window['layui-layer-iframe' + index]
                        , submitID = 'LAY-user-front-submit'
                        , submit = layero.find('iframe').contents().find('#' + submitID);

                      //监听提交
                      iframeWindow.layui.form.on('submit(' + submitID + ')', function (dataLog) {
                        var field = dataLog.field;
                        console.log("监听提交 ===================" + data)
                        //获取提交的字段
                        //提交 Ajax 成功后，静态更新表格中的数据
                        $.ajax({
                          type: "post",
                          url: "/user/updateUser",
                          data: JSON.stringify(field),
                          dataType: "json",
                          contentType: "application/json;charset-UTF-8",
                          success: function (resultJSONObject) {
                            if (resultJSONObject.success) {
                              layer.msg("更新成功");
                            } else {
                              layer.msg("更新失败");
                            }
                            console.log(data)
                          }
                        });
                    
                        table.reload('user-table'); //数据刷新
                        layer.close(index); //关闭弹层
                      });

                      submit.trigger('click');
                    }
                  });
                }
              });
            },
            error: function (msgLog) {
              layer.msg('错误', msgLog.msg);
            }
          });
        }
      });





      //监听搜索
      form.on('submit(user-search)', function (data) {
        var field = data.field;

        //执行重载
        table.reload('user-table', {
          where: field
        });
      });

      //事件
      var active = {
        batchdel: function () {
          //两种方式
          var checkStatus = table.checkStatus('user-table')
            , checkData = checkStatus.data; //得到选中的数据

          if (checkData.length === 0) {
            return layer.msg('请选择数据');
          }

          //捉到所有被选中的，发异步进行删除
          var ids = "";
          if (checkData.length > 0) {
            for (var i = 0; i < checkData.length; i++) {
              ids += checkData[i].userId + ",";
            }
          }
          layer.confirm('确定删除吗？', function (index) {
            //执行 Ajax 后重载
            $.ajax({
              type: "post",
              url: "/user/deleteUserAlls",
              data: { "ids": ids },
              success: function (data) {
                if (data.success) {
                  layer.msg('已删除');
                  table.reload('user-table'); //数据刷新
                } else {
                  layer.msg('禁止删除');
                }
                console.log(data)
              }
            });

          });

        }
        , add: function () {
          layer.open({
            type: 2
            , title: '添加用户'
            , content: '/user/updateInfo?type=1'
            , maxmin: true
            , area: ['700px', '550px']
            , fixed: true
            , shadeClose: true//开启遮罩关
            , shade: 0.9 
            , moveType: 1 //拖拽模式，0或者1 
            , btn: ['确定', '取消']
            , yes: function (index, layero) {
              var iframeWindow = window['layui-layer-iframe' + index]
                , submitID = 'LAY-user-front-submit'
                , submit = layero.find('iframe').contents().find('#' + submitID);

              //监听提交
              iframeWindow.layui.form.on('submit(' + submitID + ')', function (data) {
                var field = data.field; //获取提交的字段

                //提交 Ajax 成功后，静态更新表格中的数据
                console.log("监听提交 ===================" + JSON.stringify(field))
                //获取提交的字段
                //提交 Ajax 成功后，静态更新表格中的数据
                deptId=$(".deptId").val();
                field.deptId = deptId;
                $.ajax({
                  type: "post",
                  url: "/user/insertUser",
                  data: JSON.stringify(field),
                  dataType: "json",
                  contentType: "application/json;charset-UTF-8",
                  success: function (resultJSONObject) {
                    if (resultJSONObject.success) {
                      layer.msg("新增成功");
                    } else {
                      layer.msg("新增失败");
                    }
                    console.log(data)
                  }
                });
                table.reload('user-table'); //数据刷新
                layer.close(index); //关闭弹层
              });

              submit.trigger('click');
            }
          });
        }

      };

      $('.layui-btn.layui-btn-sm').on('click', function () {
        var type = $(this).data('type');
        active[type] ? active[type].call(this) : '';
      });
    });



  </script>
</body>

</html>